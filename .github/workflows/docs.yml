name: ðŸ“š TypeDoc æ–‡æ¡£ç”Ÿæˆä¸Žéƒ¨ç½²

on:
  push:
    branches:
      - main
    paths:
      - 'packages/core/src/**'
      - 'packages/core/typedoc.json'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸŸ¢ é…ç½® Node.js çŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: "https://registry.npmjs.org"

      - name: ðŸ“¦ é…ç½® PNPM çŽ¯å¢ƒ
        uses: pnpm/action-setup@v4

      - name: ðŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–
        run: pnpm install

      - name: ðŸ“š ç”Ÿæˆ TypeDoc æ–‡æ¡£
        run: pnpm run types-docs:build

      - name: ðŸ” æ£€æŸ¥ç”Ÿæˆçš„æ–‡æ¡£
        run: |
          DOCS_DIR="packages/core/type-docs"
          if [ ! -d "$DOCS_DIR" ]; then
            echo "âŒ æ–‡æ¡£ç›®å½•ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          if [ ! -f "$DOCS_DIR/index.html" ]; then
            echo "âŒ æ–‡æ¡£å…¥å£æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          echo "âœ… æ–‡æ¡£ç”ŸæˆéªŒè¯é€šè¿‡"
          echo "ï¿½ ç”Ÿæˆçš„å½•æ–‡ä»¶æ•°é‡: $(find $DOCS_DIR -type f | wc -l)"
          echo "ðŸ“ æ–‡æ¡£ç›®å½•å¤§å°: $(du -sh $DOCS_DIR | cut -f1)"

      - name: ðŸš€ éƒ¨ç½²åˆ° docs åˆ†æ”¯
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./packages/core/type-docs
          publish_branch: docs
          force_orphan: true
          commit_message: 'ðŸ“š è‡ªåŠ¨æ›´æ–°æ–‡æ¡£ - ${{ github.sha }}'
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: ðŸ“Š ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
        run: |
          echo "## ðŸ“š æ–‡æ¡£éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ï¿½ è®¿é—®é“¾]æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸŒ GitHub Pages](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤å“ˆå¸Œ:** \`$(git rev-parse --short HEAD)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ç”Ÿæˆæ—¶é—´:** \`$(date '+%Y-%m-%d %H:%M:%S') (UTC)\`" >> $GITHUB_STEP_SUMMARY
