name: ðŸ“š æ–‡æ¡£ç”Ÿæˆä¸Žéƒ¨ç½²

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ç”ŸæˆTypeDocæ–‡æ¡£
  generate-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸŸ¢ é…ç½® Node.js çŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 21
          registry-url: "https://registry.npmjs.org"

      - name: ðŸ“¦ é…ç½® PNPM çŽ¯å¢ƒ
        uses: pnpm/action-setup@v4
        with:
          version: 9.13.2

      - name: ðŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–
        run: pnpm install --no-frozen-lockfile

      - name: ðŸ“š ç”ŸæˆTypeDocæ–‡æ¡£
        run: |
          pnpm run docs:build
          echo "ðŸ“– TypeDocæ–‡æ¡£ç”Ÿæˆå®Œæˆ"

      - name: ðŸ” æ£€æŸ¥ç”Ÿæˆçš„æ–‡æ¡£
        run: |
          if [ ! -d "docs" ]; then
            echo "âŒ æ–‡æ¡£ç›®å½•ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          if [ ! -f "docs/index.html" ]; then
            echo "âŒ æ–‡æ¡£å…¥å£æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          echo "âœ… æ–‡æ¡£ç”ŸæˆéªŒè¯é€šè¿‡"
          echo "ðŸ“Š ç”Ÿæˆçš„æ–‡ä»¶æ•°é‡: $(find docs -type f | wc -l)"
          echo "ðŸ“ æ–‡æ¡£ç›®å½•å¤§å°: $(du -sh docs | cut -f1)"

      - name: ðŸš€ éƒ¨ç½²åˆ°docsåˆ†æ”¯
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: docs
          force_orphan: true
          commit_message: 'ðŸ“š è‡ªåŠ¨æ›´æ–°æ–‡æ¡£ - ${{ github.sha }}'
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: ðŸ“Š ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
        run: |
          echo "## ðŸ“š æ–‡æ¡£éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“– è®¿é—®é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“š åœ¨çº¿æ–‡æ¡£](https://github.com/${{ github.repository }}/tree/docs)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸŒ GitHub Pages](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤å“ˆå¸Œ:** \`$(git rev-parse --short HEAD)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ç”Ÿæˆæ—¶é—´:** \`$(date '+%Y-%m-%d %H:%M:%S') (UTC)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **æ–‡ä»¶æ•°é‡:** $(find docs -type f | wc -l) ä¸ªæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- **ç›®å½•å¤§å°:** $(du -sh docs | cut -f1)" >> $GITHUB_STEP_SUMMARY
