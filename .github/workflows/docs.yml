name: ğŸ“š æ–‡æ¡£ç”Ÿæˆä¸éƒ¨ç½²

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ç”ŸæˆTypeDocæ–‡æ¡£
  generate-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŸ¢ é…ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 21
          registry-url: "https://registry.npmjs.org"

      - name: ğŸ“¦ é…ç½® PNPM ç¯å¢ƒ
        uses: pnpm/action-setup@v4
        with:
          version: 9.13.2

      - name: ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–
        run: pnpm install --no-frozen-lockfile

      - name: ğŸ“š ç”ŸæˆTypeDocæ–‡æ¡£
        run: |
          pnpm run docs:build
          echo "ğŸ“– TypeDocæ–‡æ¡£ç”Ÿæˆå®Œæˆ"

      - name: ğŸ” æ£€æŸ¥ç”Ÿæˆçš„æ–‡æ¡£
        run: |
          if [ ! -d "docs" ]; then
            echo "âŒ æ–‡æ¡£ç›®å½•ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          if [ ! -f "docs/index.html" ]; then
            echo "âŒ æ–‡æ¡£å…¥å£æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          echo "âœ… æ–‡æ¡£ç”ŸæˆéªŒè¯é€šè¿‡"
          echo "ğŸ“Š ç”Ÿæˆçš„æ–‡ä»¶æ•°é‡: $(find docs -type f | wc -l)"
          echo "ğŸ“ æ–‡æ¡£ç›®å½•å¤§å°: $(du -sh docs | cut -f1)"

      - name: ğŸš€ éƒ¨ç½²åˆ°docsåˆ†æ”¯
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: docs
          force_orphan: true
          commit_message: 'ğŸ“š è‡ªåŠ¨æ›´æ–°æ–‡æ¡£ - ${{ github.sha }}'
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: ğŸ“Š ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
        run: |
          echo "## ğŸ“š æ–‡æ¡£éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“– è®¿é—®é“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ“š åœ¨çº¿æ–‡æ¡£](https://github.com/${{ github.repository }}/tree/docs)" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸŒ GitHub Pages](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤å“ˆå¸Œ:** \`$(git rev-parse --short HEAD)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ç”Ÿæˆæ—¶é—´:** \`$(date '+%Y-%m-%d %H:%M:%S') (UTC)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **æ–‡ä»¶æ•°é‡:** $(find docs -type f | wc -l) ä¸ªæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- **ç›®å½•å¤§å°:** $(du -sh docs | cut -f1)" >> $GITHUB_STEP_SUMMARY

  # é…ç½®GitHub Pagesï¼ˆå¯é€‰ï¼‰
  setup-pages:
    runs-on: ubuntu-latest
    needs: generate-docs
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ”§ å¯ç”¨GitHub Pages
        run: |
          echo "ğŸ’¡ æç¤ºï¼šå¦‚éœ€å¯ç”¨GitHub Pagesï¼Œè¯·å‰å¾€ä»“åº“è®¾ç½®é¡µé¢ï¼š"
          echo "Settings -> Pages -> Source -> Deploy from a branch -> docsåˆ†æ”¯"
          echo "" 
          echo "ğŸ“š æ–‡æ¡£å°†åœ¨ä»¥ä¸‹åœ°å€å¯è®¿é—®ï¼š"
          echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"