name: Release

on:
  # æ‰‹åŠ¨è§¦å‘å‘å¸ƒ
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 6.0.0-beta.0, 6.0.0)'
        required: true
        type: string
      tag:
        description: 'npm å‘å¸ƒæ ‡ç­¾'
        required: true
        type: choice
        options:
          - beta
          - alpha
          - rc
          - latest

permissions:
  contents: write
  id-token: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z]+\.[0-9]+)?$ ]]; then
            echo "âŒ æ— æ•ˆçš„ç‰ˆæœ¬å·æ ¼å¼: $VERSION"
            echo "   æ­£ç¡®æ ¼å¼: x.y.z æˆ– x.y.z-prerelease.n"
            exit 1
          fi
          echo "âœ… ç‰ˆæœ¬å·æ ¼å¼æ­£ç¡®: $VERSION"

      - name: Validate tag and version match
        run: |
          VERSION="${{ inputs.version }}"
          TAG="${{ inputs.tag }}"
          
          # latest æ ‡ç­¾åªèƒ½ç”¨äºæ­£å¼ç‰ˆæœ¬
          if [[ "$TAG" == "latest" && "$VERSION" == *"-"* ]]; then
            echo "âŒ latest æ ‡ç­¾åªèƒ½ç”¨äºæ­£å¼ç‰ˆæœ¬ (ä¸å«é¢„å‘å¸ƒåç¼€)"
            exit 1
          fi
          
          # é¢„å‘å¸ƒæ ‡ç­¾å¿…é¡»ç”¨äºé¢„å‘å¸ƒç‰ˆæœ¬
          if [[ "$TAG" != "latest" && "$VERSION" != *"-"* ]]; then
            echo "âŒ $TAG æ ‡ç­¾åªèƒ½ç”¨äºé¢„å‘å¸ƒç‰ˆæœ¬"
            exit 1
          fi
          
          echo "âœ… æ ‡ç­¾éªŒè¯é€šè¿‡"

      - name: Check if tag exists
        run: |
          TAG="v${{ inputs.version }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "âŒ æ ‡ç­¾ $TAG å·²å­˜åœ¨"
            exit 1
          fi
          echo "âœ… æ ‡ç­¾ $TAG å¯ç”¨"

      - name: Validate version is greater than current
        run: |
          INPUT_VERSION="${{ inputs.version }}"
          
          # è·å– package.json ä¸­çš„ç‰ˆæœ¬
          CURRENT_VERSION=$(node -p "require('./packages/core/package.json').version")
          echo "ğŸ“¦ å½“å‰ package.json ç‰ˆæœ¬: $CURRENT_VERSION"
          echo "ğŸ“¦ è¾“å…¥ç‰ˆæœ¬: $INPUT_VERSION"
          
          # è·å–æœ€æ–°çš„ tag ç‰ˆæœ¬
          LATEST_TAG=$(git tag -l 'v*' --sort=-v:refname | head -n 1 | sed 's/^v//' || echo "0.0.0")
          echo "ğŸ“¦ æœ€æ–° tag ç‰ˆæœ¬: $LATEST_TAG"
          
          # ä½¿ç”¨ node æ¯”è¾ƒç‰ˆæœ¬å·
          node -e "
            const semver = {
              parse: (v) => {
                const match = v.match(/^(\d+)\.(\d+)\.(\d+)(?:-([a-zA-Z]+)\.(\d+))?$/);
                if (!match) return null;
                return {
                  major: parseInt(match[1]),
                  minor: parseInt(match[2]),
                  patch: parseInt(match[3]),
                  prerelease: match[4] || null,
                  prereleaseNum: match[5] ? parseInt(match[5]) : null
                };
              },
              compare: (a, b) => {
                const va = semver.parse(a);
                const vb = semver.parse(b);
                if (!va || !vb) return 0;
                
                // æ¯”è¾ƒä¸»ç‰ˆæœ¬å·
                if (va.major !== vb.major) return va.major - vb.major;
                if (va.minor !== vb.minor) return va.minor - vb.minor;
                if (va.patch !== vb.patch) return va.patch - vb.patch;
                
                // é¢„å‘å¸ƒç‰ˆæœ¬æ¯”è¾ƒ
                if (!va.prerelease && vb.prerelease) return 1;  // æ­£å¼ç‰ˆ > é¢„å‘å¸ƒ
                if (va.prerelease && !vb.prerelease) return -1; // é¢„å‘å¸ƒ < æ­£å¼ç‰ˆ
                if (!va.prerelease && !vb.prerelease) return 0;
                
                // éƒ½æ˜¯é¢„å‘å¸ƒç‰ˆæœ¬
                const order = { alpha: 0, beta: 1, rc: 2 };
                const orderA = order[va.prerelease] ?? 99;
                const orderB = order[vb.prerelease] ?? 99;
                if (orderA !== orderB) return orderA - orderB;
                
                return (va.prereleaseNum || 0) - (vb.prereleaseNum || 0);
              }
            };
            
            const input = '$INPUT_VERSION';
            const current = '$CURRENT_VERSION';
            const latestTag = '$LATEST_TAG';
            
            const compareWithCurrent = semver.compare(input, current);
            const compareWithTag = semver.compare(input, latestTag);
            
            console.log('');
            if (compareWithCurrent <= 0) {
              console.log('âŒ è¾“å…¥ç‰ˆæœ¬ ' + input + ' å¿…é¡»å¤§äºå½“å‰ package.json ç‰ˆæœ¬ ' + current);
              process.exit(1);
            }
            
            if (latestTag !== '0.0.0' && compareWithTag <= 0) {
              console.log('âŒ è¾“å…¥ç‰ˆæœ¬ ' + input + ' å¿…é¡»å¤§äºæœ€æ–° tag ç‰ˆæœ¬ ' + latestTag);
              process.exit(1);
            }
            
            console.log('âœ… ç‰ˆæœ¬éªŒè¯é€šè¿‡: ' + input + ' > ' + current + ' (package.json)');
            if (latestTag !== '0.0.0') {
              console.log('âœ… ç‰ˆæœ¬éªŒè¯é€šè¿‡: ' + input + ' > ' + latestTag + ' (latest tag)');
            }
          "

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - name: Update npm to latest
        run: npm install -g npm@latest

      - name: Install dependencies
        run: pnpm install

      - name: Build core package
        run: pnpm run build:core

      - name: Update version in package.json
        run: |
          cd packages/core
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '${{ inputs.version }}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
          echo "âœ… æ›´æ–° package.json ç‰ˆæœ¬å·ä¸º ${{ inputs.version }}"

      - name: Generate changelog for this release
        id: changelog
        run: |
          # ä½¿ç”¨è‡ªå®šä¹‰è„šæœ¬ç”Ÿæˆ changelog
          CHANGELOG=$(node scripts/generate-release-notes.js "${{ inputs.version }}")
          
          # ä¿å­˜åˆ°æ–‡ä»¶
          echo "$CHANGELOG" > /tmp/release-notes.md
          
          # ä¿å­˜åˆ° GITHUB_OUTPUT
          {
            echo 'CHANGELOG<<EOF'
            cat /tmp/release-notes.md
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Clean package.json for publish
        run: |
          cd packages/core
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            delete pkg.devDependencies;
            delete pkg.scripts;
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "

      - name: Publish to npm with provenance
        run: |
          cd packages/core
          pnpm publish --no-git-checks --tag ${{ inputs.tag }} --provenance

      - name: Restore package.json and commit version update
        run: |
          git checkout packages/core/package.json
          
          cd packages/core
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '${{ inputs.version }}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
          
          cd ../..
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/core/package.json
          git commit -m "chore(release): v${{ inputs.version }}"

      - name: Create and push tag
        run: |
          git tag "v${{ inputs.version }}"
          git push origin main
          git push origin "v${{ inputs.version }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: v${{ inputs.version }}
          body: ${{ steps.changelog.outputs.CHANGELOG }}
          prerelease: ${{ inputs.tag != 'latest' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## ğŸ‰ å‘å¸ƒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **npm æ ‡ç­¾**: ${{ inputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é¢„å‘å¸ƒ**: ${{ inputs.tag != 'latest' && 'æ˜¯' || 'å¦' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å®‰è£…å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          if [[ "${{ inputs.tag }}" == "latest" ]]; then
            echo "npm install @ikenxuan/amagi" >> $GITHUB_STEP_SUMMARY
          else
            echo "npm install @ikenxuan/amagi@${{ inputs.tag }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY
